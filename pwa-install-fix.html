<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Buddy - PWA Installation Fix</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .status-card.success {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .status-card.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .status-card.warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .status-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .status-message {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .fix-section {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .fix-section h3 {
            color: #1e40af;
            margin-bottom: 20px;
        }

        .fix-steps {
            list-style: none;
            padding: 0;
        }

        .fix-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-number {
            background: #3b82f6;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .step-description {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .install-button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 20px 0;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .install-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .diagnostic-results {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 10px 0;
        }

        .platform-specific {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .platform-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .platform-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .refresh-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± PWA Installation Diagnostic</h1>
            <p>Fix Budget Buddy app installation issues</p>
        </div>

        <div class="status-grid" id="statusGrid">
            <!-- Status cards will be populated by JavaScript -->
        </div>

        <button class="install-button" id="installBtn" style="display: none;">
            üì± Install Budget Buddy App
        </button>

        <div class="diagnostic-results" id="diagnosticResults">
            <h3>üîç Diagnostic Results</h3>
            <div id="resultsContent">Running diagnostics...</div>
        </div>

        <div class="fix-section">
            <h3>üõ†Ô∏è Common Installation Fixes</h3>
            <ul class="fix-steps">
                <li class="fix-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Serve over HTTPS</div>
                        <div class="step-description">
                            PWAs require HTTPS. Use a local server or deploy to a hosting service.
                            <div class="code-block">
# Using Python
python -m http.server 8000

# Using Node.js
npx serve .

# Using Live Server (VS Code extension)
                            </div>
                        </div>
                    </div>
                </li>
                <li class="fix-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Check Icon Files</div>
                        <div class="step-description">
                            Ensure all icon files exist and are valid PNG images. Missing icons prevent installation.
                        </div>
                    </div>
                </li>
                <li class="fix-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Verify Service Worker</div>
                        <div class="step-description">
                            Service worker must register successfully and be served from the same origin.
                        </div>
                    </div>
                </li>
                <li class="fix-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Clear Browser Cache</div>
                        <div class="step-description">
                            Clear browser cache and hard refresh (Ctrl+F5) to reload PWA configuration.
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="platform-specific">
            <div class="platform-card">
                <div class="platform-icon">üì±</div>
                <h4>Mobile Installation</h4>
                <p><strong>Chrome/Edge:</strong> Look for "Add to Home Screen" in menu</p>
                <p><strong>Safari:</strong> Share button ‚Üí "Add to Home Screen"</p>
                <p><strong>Firefox:</strong> Menu ‚Üí "Install" or "Add to Home Screen"</p>
            </div>
            <div class="platform-card">
                <div class="platform-icon">üíª</div>
                <h4>Desktop Installation</h4>
                <p><strong>Chrome:</strong> Install icon in address bar or menu</p>
                <p><strong>Edge:</strong> Apps menu ‚Üí "Install this site as an app"</p>
                <p><strong>Firefox:</strong> Limited PWA support</p>
            </div>
        </div>

        <button class="refresh-btn" onclick="runDiagnostics()">üîÑ Refresh Diagnostics</button>
        <button class="refresh-btn" onclick="fixCommonIssues()">üõ†Ô∏è Auto-Fix Issues</button>
        <button class="refresh-btn" onclick="window.open('/', '_blank')">üè† Open Main App</button>
    </div>

    <script>
        let deferredPrompt;
        let installationSupported = false;

        // PWA installation criteria
        const pwaRequirements = [
            {
                name: 'HTTPS Protocol',
                check: () => location.protocol === 'https:' || location.hostname === 'localhost',
                fix: 'Serve your app over HTTPS or use localhost for testing'
            },
            {
                name: 'Web App Manifest',
                check: async () => {
                    try {
                        const response = await fetch('/manifest.json');
                        return response.ok;
                    } catch {
                        return false;
                    }
                },
                fix: 'Ensure manifest.json exists and is accessible'
            },
            {
                name: 'Service Worker',
                check: () => 'serviceWorker' in navigator,
                fix: 'Service Worker API not supported in this browser'
            },
            {
                name: 'Service Worker Registered',
                check: async () => {
                    try {
                        const registration = await navigator.serviceWorker.getRegistration();
                        return !!registration;
                    } catch {
                        return false;
                    }
                },
                fix: 'Service worker failed to register'
            },
            {
                name: 'Required Icons',
                check: async () => {
                    const iconSizes = ['192x192', '512x512'];
                    const checks = iconSizes.map(async size => {
                        try {
                            const response = await fetch(`/icons/icon-${size}.png`);
                            return response.ok;
                        } catch {
                            return false;
                        }
                    });
                    const results = await Promise.all(checks);
                    return results.every(result => result);
                },
                fix: 'Missing required icon files (192x192, 512x512)'
            }
        ];

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üí° PWA installation prompt available');
            e.preventDefault();
            deferredPrompt = e;
            installationSupported = true;
            showInstallButton();
        });

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            deferredPrompt = null;
            hideInstallButton();
        });

        function showInstallButton() {
            const installBtn = document.getElementById('installBtn');
            installBtn.style.display = 'block';
            installBtn.onclick = installApp;
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('installBtn');
            installBtn.style.display = 'none';
        }

        async function installApp() {
            if (!deferredPrompt) {
                alert('Installation not available. Please check the diagnostic results below.');
                return;
            }

            const result = await deferredPrompt.prompt();
            console.log('Install prompt result:', result);

            if (result.outcome === 'accepted') {
                console.log('‚úÖ User accepted installation');
            } else {
                console.log('‚ùå User dismissed installation');
            }

            deferredPrompt = null;
            hideInstallButton();
        }

        async function runDiagnostics() {
            const statusGrid = document.getElementById('statusGrid');
            const resultsContent = document.getElementById('resultsContent');
            
            statusGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">üîÑ Running diagnostics...</div>';
            resultsContent.innerHTML = 'Running diagnostics...';

            const results = [];
            
            for (const requirement of pwaRequirements) {
                try {
                    const passed = await requirement.check();
                    results.push({
                        name: requirement.name,
                        passed,
                        fix: requirement.fix
                    });
                } catch (error) {
                    results.push({
                        name: requirement.name,
                        passed: false,
                        fix: requirement.fix,
                        error: error.message
                    });
                }
            }

            displayResults(results);
            displayStatusCards(results);
        }

        function displayStatusCards(results) {
            const statusGrid = document.getElementById('statusGrid');
            statusGrid.innerHTML = '';

            results.forEach(result => {
                const card = document.createElement('div');
                card.className = `status-card ${result.passed ? 'success' : 'error'}`;
                
                card.innerHTML = `
                    <div class="status-icon">${result.passed ? '‚úÖ' : '‚ùå'}</div>
                    <div class="status-title">${result.name}</div>
                    <div class="status-message">
                        ${result.passed ? 'Working correctly' : result.fix}
                        ${result.error ? `<br><small>Error: ${result.error}</small>` : ''}
                    </div>
                `;
                
                statusGrid.appendChild(card);
            });

            // Add installation status card
            const installCard = document.createElement('div');
            const allPassed = results.every(r => r.passed);
            installCard.className = `status-card ${allPassed ? 'success' : 'warning'}`;
            
            installCard.innerHTML = `
                <div class="status-icon">${allPassed ? 'üì±' : '‚ö†Ô∏è'}</div>
                <div class="status-title">Installation Status</div>
                <div class="status-message">
                    ${allPassed ? 'Ready to install!' : 'Fix issues above to enable installation'}
                </div>
            `;
            
            statusGrid.appendChild(installCard);
        }

        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');
            
            const passedCount = results.filter(r => r.passed).length;
            const totalCount = results.length;
            
            let html = `
                <h4>üìä Results: ${passedCount}/${totalCount} checks passed</h4>
                <div style="margin: 15px 0;">
            `;

            results.forEach(result => {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: ${result.passed ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
                        <strong>${result.passed ? '‚úÖ' : '‚ùå'} ${result.name}</strong><br>
                        <small style="color: #6b7280;">${result.passed ? 'Working correctly' : result.fix}</small>
                    </div>
                `;
            });

            html += '</div>';

            // Add browser-specific instructions
            html += `
                <h4>üåê Browser-Specific Instructions</h4>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>Current Browser:</strong> ${navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                                                      navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                                                      navigator.userAgent.includes('Safari') ? 'Safari' : 
                                                      navigator.userAgent.includes('Edge') ? 'Edge' : 'Unknown'}<br>
                    <strong>Installation Support:</strong> ${installationSupported ? 'Available' : 'Not detected'}
                </div>
            `;

            resultsContent.innerHTML = html;
        }

        async function fixCommonIssues() {
            console.log('üõ†Ô∏è Attempting to fix common issues...');
            
            // Try to register service worker if not registered
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service worker registered:', registration);
                } catch (error) {
                    console.error('‚ùå Service worker registration failed:', error);
                }
            }

            // Clear caches and reload
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                console.log('‚úÖ Caches cleared');
            }

            // Refresh diagnostics
            setTimeout(() => {
                runDiagnostics();
            }, 1000);
        }

        // Initialize diagnostics on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç PWA Installation Diagnostic Tool loaded');
            runDiagnostics();
            
            // Check if already installable
            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ App is already installed');
            }
        });

        // Additional diagnostic info
        console.log('üîç PWA Diagnostic Information:');
        console.log('Protocol:', location.protocol);
        console.log('Hostname:', location.hostname);
        console.log('Service Worker Support:', 'serviceWorker' in navigator);
        console.log('User Agent:', navigator.userAgent);
    </script>
</body>
</html>
